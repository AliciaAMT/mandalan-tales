<ion-content fullscreen appFocusManager>
  <div
    class="main-game-responsive-grid"
    [ngStyle]="{
      'grid-template-rows': gridTemplateRows,
      'grid-template-columns': gridTemplateColumns,
      'grid-template-areas': gridTemplateAreas
    }"
  >
    <!-- Player Stats (Left/Top) -->
    <div class="main-section player-stats" [ngClass]="{'collapsed': !isPlayerStatsOpen}" [style.grid-area]="playerStatsArea">
      <button class="collapsible-header" (click)="togglePlayerStats()">Player Stats</button>
      <div class="section-content" *ngIf="isPlayerStatsOpen">
        <ng-container *ngIf="currentCharacter; else noChar">
          <div class="player-stats-list">
            <div class="player-stats-row portrait-row">
              <img class="stat-icon portrait" [src]="'assets/portraits/transparent/' + currentCharacter.portrait + '.png'" alt="Portrait" />
              <div class="player-name-title" *ngIf="isMobile">
                <strong>{{ currentCharacter.name }}</strong>
                <span *ngIf="currentCharacter.title">({{ currentCharacter.title }})</span>
              </div>
            </div>
            <div class="player-stats-row name-row" *ngIf="!isMobile">
              <div class="player-name-title">
                <strong>{{ currentCharacter.name }}</strong>
                <span *ngIf="currentCharacter.title">({{ currentCharacter.title }})</span>
              </div>
            </div>

            <!-- Mobile: Stat columns row -->
            <div class="player-stats-row stats-columns-row" *ngIf="isMobile">
              <div class="stats-col stats-col-1">
                <div class="player-stats-row">
                  <img class="stat-icon" src="assets/items/hourglass.webp" alt="Level" />
                  <div>
                    <div>Level {{ currentCharacter.level }}</div>
                    <div>XP: {{ currentCharacter.experience }}</div>
                  </div>
                </div>
                <div class="player-stats-row">
                  <img class="stat-icon" src="assets/items/gold.webp" alt="Gold" />
                  <div>Gold: <span class="gold-amount">{{ currentCharacter.gold }}</span></div>
                </div>
              </div>
              <div class="stats-col stats-col-2">
                <div class="player-stats-row">
                  <img class="stat-icon" src="assets/items/life.webp" alt="Life" />
                  <div>Life: {{ currentCharacter.life }} / {{ currentCharacter.maxLife }}</div>
                </div>
                <div class="player-stats-row">
                  <img class="stat-icon" src="assets/items/mana.webp" alt="Mana" />
                  <div>Mana: {{ currentCharacter.mana }} / {{ currentCharacter.maxMana }}</div>
                </div>
              </div>
            </div>

            <!-- Desktop: Original stat rows -->
            <ng-container *ngIf="!isMobile">
              <div class="player-stats-row">
                <img class="stat-icon" src="assets/items/hourglass.webp" alt="Level" />
                <div>Level {{ currentCharacter.level }}<br>XP: {{ currentCharacter.experience }}</div>
              </div>
              <div class="player-stats-row">
                <img class="stat-icon" src="assets/items/life.webp" alt="Life" />
                <div>Life: {{ currentCharacter.life }} / {{ currentCharacter.maxLife }}</div>
              </div>
              <div class="player-stats-row">
                <img class="stat-icon" src="assets/items/mana.webp" alt="Mana" />
                <div>Mana: {{ currentCharacter.mana }} / {{ currentCharacter.maxMana }}</div>
              </div>
              <div class="player-stats-row">
                <img class="stat-icon" src="assets/items/gold.webp" alt="Gold" />
                <div>Gold: <span class="gold-amount">{{ currentCharacter.gold }}</span></div>
              </div>
            </ng-container>
          </div>
        </ng-container>
        <ng-template #noChar>
          <div>No character loaded.</div>
        </ng-template>
      </div>
    </div>

    <!-- Map (Center/Second) -->
    <div class="main-section map" [ngClass]="{'collapsed': !isMapOpen}" [style.grid-area]="mapArea">
      <button class="collapsible-header" (click)="toggleMap()">Map</button>
      <div class="section-content" *ngIf="isMapOpen">
        <div class="map-container" *ngIf="currentCharacter; else noMap">
          <div class="map-grid" #mapGrid>
            <div
              *ngFor="let row of mapTiles; let rowIndex = index"
              class="map-row"
            >
              <div
                *ngFor="let tile of row; let colIndex = index"
                class="map-tile"
                [class.player-tile]="tile.isPlayer"
                [class.clickable-tile]="tile.isClickable"
                [class.invalid-tile]="tile.imageSrc.includes('yard00.webp') && !tile.isPlayer"
                (click)="onTileClick(tile)"
                (keydown.enter)="onTileClick(tile)"
                (keydown.space)="onTileClick(tile)"
                [attr.aria-label]="getTileAriaLabel(tile)"
                [tabindex]="tile.isClickable ? 0 : -1"
                role="button"
              >
                <img
                  [src]="tile.imageSrc"
                  [alt]="getTileAltText(tile)"
                  class="tile-image"
                  (error)="onTileImageError($event, tile)"
                />
                <div class="tile-overlay" *ngIf="tile.isPlayer">
                  <div class="player-indicator">YOU</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Debug section - hidden from screen readers and keyboard navigation -->
          <div class="debug-info"
               style="margin-top: 20px; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 8px;"
               tabindex="-1"
               aria-hidden="true">
            <h4>Debug Info:</h4>
            <p>Map Tiles Count: {{ mapTiles.length }}</p>
            <p *ngIf="mapTiles.length > 0">First Row Tiles: {{ mapTiles[0].length }}</p>

            <!-- Test buttons - not keyboard accessible -->
            <div style="margin: 10px 0;">
              <button (click)="generateTestMap()"
                      style="margin-right: 10px; padding: 5px 10px;"
                      tabindex="-1"
                      aria-hidden="true">Generate Test Map</button>
              <button (click)="generateMap()"
                      style="padding: 5px 10px;"
                      tabindex="-1"
                      aria-hidden="true">Generate Real Map</button>
            </div>

            <div *ngFor="let row of mapTiles; let rowIndex = index">
              <p>Row {{ rowIndex }}:</p>
              <ul>
                <li *ngFor="let tile of row">
                  ({{ tile.x }}, {{ tile.y }}) - {{ tile.imageSrc }} - Player: {{ tile.isPlayer }} - Clickable: {{ tile.isClickable }}
                </li>
              </ul>
            </div>
          </div>
        </div>
        <ng-template #noMap>
          <div class="no-map-message">No character loaded.</div>
        </ng-template>
      </div>
    </div>

    <!-- Tile Actions (Right/Third) -->
    <div class="main-section tile-actions" [ngClass]="{'collapsed': !isTileActionsOpen}" [style.grid-area]="tileActionsArea">
      <button class="collapsible-header" (click)="toggleTileActions()">Tile Actions</button>
      <div class="section-content" *ngIf="isTileActionsOpen">
        <span>Tile Actions Placeholder</span>
      </div>
    </div>

    <!-- Menu (Bottom/Last) -->
    <div class="main-section menu" [ngClass]="{'collapsed': !isMenuOpen}" [style.grid-area]="menuArea">
      <button class="collapsible-header" (click)="toggleMenu()">Menu</button>
      <div class="section-content" *ngIf="isMenuOpen">
        <span>Menu Placeholder</span>
      </div>
    </div>
  </div>
</ion-content>
